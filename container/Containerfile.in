/* 
BUILD SPAMTAGGER BASE IMAGE

Fourth stage builds the SpamTagger (Core) image as a standard (non-BootC) container.
It builds from the bootc-base so that those tools are already pre-installed.
*/

FROM SOURCE_IMAGE as spamtagger-base

ARG TERM=xterm 
ARG DEBIAN_FRONTEND=noninteractive
#ifdef CI_SETX
ARG CI=1
#endif /* CI_SETX */

/* IMAGE_VERSION like 'spamtagger-core-13-20250101''; generated by Justfile */
ARG IMAGE_VERSION=IMAGE_VERSION_SUB
/* Debian-friendly architecture shortname */
ARG ARCH=ARCH_SUB
/* SpamTagger VARIANT name like 'spamtagger-core'. Optionally given to
`just build` as first argument. Available options from images.yml */
ARG VARIANT=VARIANT_SUB
/* SpamTagger VERSION like '13'. Optionally given to `just build` as Second
argument. Available options from images.yml */
ARG VERSION=VERSION_SUB

/* Allow for colored output */
ARG TERM=xterm 
/* Run APT without input */
ARG DEBIAN_FRONTEND=noninteractive
/* Define CI argument if running in CI environment */
#ifdef CI_SETX
ARG CI=1
#endif /* CI_SETX */
/* Don't use SELinux features of OSTree */
ENV OSTREE_SELINUX_ENABLE=0

/* Copy in file which contains the package list for this variant */
COPY build_files/VARIANT_SUB/packages /run/build_files/variant-packages
/* Copy in file which contains the package list for the specific version of this variant */
COPY build_files/VARIANT_SUB/VERSION_SUB/packages /run/build_files/version-packages

/* Run Bash recipe for package installations */
RUN --mount=type=cache,dst=/var/cache \
  --mount=type=tmpfs,dst=/var/log \
  --mount=type=tmpfs,dst=/var/tmp \
  --mount=type=tmpfs,dst=/tmp \
  bash <<'RUNEOF'
#include "build_files/packages"
RUNEOF

/* Run Bash recipe to configure operating system for this variant */
RUN --mount=type=cache,dst=/var/cache \
  --mount=type=tmpfs,dst=/var/log \
  --mount=type=tmpfs,dst=/var/tmp \
  --mount=type=tmpfs,dst=/tmp \
  bash <<'RUNEOF'
#include "build_files/system-configuration"
#ifdef CORE
#include "build_files/spamtagger-core/system-configuration"
#else
#include "build_files/spamtagger/system-configuration"
#endif /* CORE */
RUNEOF

/* Copy in file which contains the package list for this variant */
COPY build_files/VARIANT_SUB/cleanup-packages /run/build_files/variant-cleanup
/* Copy in file which contains the package list for the specific version of this variant */
COPY build_files/VARIANT_SUB/VERSION_SUB/cleanup-packages /run/build_files/version-cleanup

/* Run Bash recipe to clean up unnecessary files and packages */
RUN --mount=type=cache,dst=/var/cache \
  --mount=type=tmpfs,dst=/var/log \
  --mount=type=tmpfs,dst=/var/tmp \
  --mount=type=tmpfs,dst=/tmp \
  bash <<'RUNEOF'
/* Remove unnecessary files/repositories/etc. */
#include "build_files/cleanup"
RUNEOF

/* Copy in cosign.pub key */
COPY cosign.pub /run/cosign.pub

/* Run Bash recipe to finalize image */
RUN bash <<'RUNEOF'
#include "build_files/finalize"
RUNEOF

/* Remove APT logs
For some reason removing them as part of the last step doesn't work, but it does work as an additional RUN command???
*/
RUN ["rm", "-rf", "/var/log/apt"]

/* Test BootC image */
RUN ["bootc", "container", "lint", "--fatal-warnings", "--no-truncate"]
RUN ["nbc", "lint", "--local"]

/* LABELS will be added by Justfile */
