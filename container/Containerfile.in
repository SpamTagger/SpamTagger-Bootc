/* Build Perl, install SpamTagger version and bundle with staticperl in seperate stage */
FROM registry.fedoraproject.org/fedora:latest as perl-builder

/* Allow for colored output */
ARG TERM=xterm 
/* Define CI argument if running in CI environment */
#ifdef CI_SETX
ARG CI=1
#endif /* CI_SETX */

/* Add detect-modules.pl for staticperl bundling */
COPY build_files/detect-modules.pl /run/build-files/

/* Generate version-specific module list for CPAN */
RUN bash <<'RUNEOF'
/* Install latest stable Perl */
#include "build_files/10-perl.sh"
/* Install SpamTagger source at /usr/spamtagger */
#ifdef PLUS
#include "build_files/spamtagger-plus/10-application.sh"
#else
#include "build_files/spamtagger/10-application.sh"
#endif /* PLUS */
RUNEOF

/* Dynamically insert CentOS version for final container */
FROM SOURCE_IMAGE as spamtagger-bootc

/* Redeclare vars */
ARG IMAGE_VERSION_ARG
ARG TERM=xterm
#ifdef CI_SETX
ARG CI
#endif /* CI_SETX */

/* Prepare filesystem for OSTree */
RUN --mount=type=cache,dst=/var/cache \
    --mount=type=tmpfs,dst=/var/log \
    --mount=type=tmpfs,dst=/var/tmp \
    --mount=type=tmpfs,dst=/tmp \
    bash <<'RUNEOF'
#include "build_files/01-common.sh"
ostree container commit
RUNEOF

/* Add staticperl and application from build container */
COPY --from=perl-builder /opt/staticperl /opt/staticperl
/* Add SpamTagger from build container */
COPY --from=perl-builder /usr/spamtagger /usr/spamtagger

/* Only needed for add-ons
*/

/* Install Packages */
RUN --mount=type=cache,dst=/var/cache \
    --mount=type=tmpfs,dst=/var/log \
    --mount=type=tmpfs,dst=/var/tmp \
    --mount=type=tmpfs,dst=/tmp \
    bash <<'RUNEOF'
/* Install version-specific packages */
#ifdef PLUS
#include "build_files/spamtagger-plus/10-packages.sh"
#else
#include "build_files/spamtagger/10-packages.sh"
#endif /* PLUS */
ostree container commit
RUNEOF

/* Configure OS and Application */
RUN --mount=type=cache,dst=/var/cache \
    --mount=type=tmpfs,dst=/var/log \
    --mount=type=tmpfs,dst=/var/tmp \
    --mount=type=tmpfs,dst=/tmp \
    bash <<'RUNEOF'
/* Configure system and services */
#include "build_files/13-base-configurations.sh"
/* Configure version-specific application */
#ifdef PLUS
#include "build_files/spamtagger-plus/13-configuration.sh"
#else
#include "build_files/spamtagger/13-configuration.sh"
#endif /* PLUS */
ostree container commit
RUNEOF

/* Clean up installation */
RUN --mount=type=cache,dst=/var/cache \
    --mount=type=tmpfs,dst=/var/log \
    --mount=type=tmpfs,dst=/var/tmp \
    --mount=type=tmpfs,dst=/tmp \
    bash <<'RUNEOF'
/* Remove unnecessary files/repositories/etc. */
#include "build_files/98-cleanup.sh"
/* Remove packages and files not needed for specific version */
#ifdef PLUS
#include "build_files/spamtagger-plus/98-cleanup.sh"
#else
#include "build_files/spamtagger/98-cleanup.sh"
#endif /* PLUS */
ostree container commit
RUNEOF

/* Finalize OSTree */
RUN bash <<'RUNEOF'
#include "build_files/99-finalize.sh"
RUNEOF

/* Set default environment variables */
ENV PATH=/usr/spamtagger/bin:$PATH
ENV PERL5LIB=/opt/staticperl/lib/perl5:/usr/spamtagger/lib

/* Create Bootc image from OSTree */
RUN ["bootc", "container", "lint", "--fatal-warnings", "--no-truncate"]
