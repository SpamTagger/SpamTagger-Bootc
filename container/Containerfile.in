/* 
BUILD EXIM

First stage image used to build custom Exim package with our extra features not
otherwise available in Debian's version.
*/

/* Dynamically insert base image from 'source' in images.yml*/
FROM debian:stable as exim-builder

ARG TERM=xterm 
ARG DEBIAN_FRONTEND=noninteractive
#ifdef CI_SETX
ARG CI=1
#endif /* CI_SETX */

/* EXIM_VERSION to build; loaded from images.yml */
ARG EXIM_VERSION=EXIM_VERSION_SUB
/* Debian-friendly architecture shortname */
ARG ARCH=ARCH_SUB

/* Copy in file which contains the dependency list */
COPY build_files/exim-builder-deps /run/build_files/exim-builder-deps
/* Copy in directory which contains the Debian packaging metadata*/
COPY build_files/exim-files /run/build_files/exim-files

/* Run Bash recipe for Exim build */
RUN --mount=type=cache,dst=/var/cache \
  --mount=type=tmpfs,dst=/var/log \
  --mount=type=tmpfs,dst=/var/tmp \
  --mount=type=tmpfs,dst=/tmp \
  bash <<'RUNEOF'
#include "build_files/build-exim"
RUNEOF

/* 
BUILD SPAMTAGGER BASE IMAGE

Fourth stage builds the SpamTagger (Plus) image as a standard (non-BootC) container.
It builds from the bootc-base so that those tools are already pre-installed.
*/

FROM SOURCE_IMAGE as spamtagger-base

ARG TERM=xterm 
ARG DEBIAN_FRONTEND=noninteractive
#ifdef CI_SETX
ARG CI=1
#endif /* CI_SETX */

/* IMAGE_VERSION like 'spamtagger-plus-13-20250101''; generated by Justfile */
ARG IMAGE_VERSION=IMAGE_VERSION_SUB
/* Debian-friendly architecture shortname */
ARG ARCH=ARCH_SUB
/* SpamTagger VARIANT name like 'spamtagger-plus'. Optionally given to
`just build` as first argument. Available options from images.yml */
ARG VARIANT=VARIANT_SUB
/* SpamTagger VERSION like '13'. Optionally given to `just build` as Second
argument. Available options from images.yml */
ARG VERSION=VERSION_SUB

/* Allow for colored output */
ARG TERM=xterm 
/* Run APT without input */
ARG DEBIAN_FRONTEND=noninteractive
/* Define CI argument if running in CI environment */
#ifdef CI_SETX
ARG CI=1
#endif /* CI_SETX */
/* Don't use SELinux features of OSTree */
ENV OSTREE_SELINUX_ENABLE=0

/* Copy in file which contains the package list for this variant */
COPY build_files/VARIANT_SUB/packages /run/build_files/variant-packages
/* Copy in file which contains the package list for the specific version of this variant */
COPY build_files/VARIANT_SUB/VERSION_SUB/packages /run/build_files/version-packages

/* Run Bash recipe for package installations */
RUN --mount=type=cache,dst=/var/cache \
  --mount=type=tmpfs,dst=/var/log \
  --mount=type=tmpfs,dst=/var/tmp \
  --mount=type=tmpfs,dst=/tmp \
  --mount=type=bind,from=exim-builder,source=/,dst=/run/exim-builder \
  bash <<'RUNEOF'
#include "build_files/packages"
RUNEOF

/* Run Bash recipe to configure operating system for this variant */
RUN --mount=type=cache,dst=/var/cache \
  --mount=type=tmpfs,dst=/var/log \
  --mount=type=tmpfs,dst=/var/tmp \
  --mount=type=tmpfs,dst=/tmp \
  bash <<'RUNEOF'
#include "build_files/system-configuration"
#ifdef PLUS
#include "build_files/spamtagger-plus/system-configuration"
#else
#include "build_files/spamtagger/system-configuration"
#endif /* PLUS */
RUNEOF

/* Copy in file which contains the package list for this variant */
COPY build_files/VARIANT_SUB/cleanup-packages /run/build_files/variant-cleanup
/* Copy in file which contains the package list for the specific version of this variant */
COPY build_files/VARIANT_SUB/VERSION_SUB/cleanup-packages /run/build_files/version-cleanup

/* Run Bash recipe to clean up unnecessary files and packages */
RUN --mount=type=cache,dst=/var/cache \
  --mount=type=tmpfs,dst=/var/log \
  --mount=type=tmpfs,dst=/var/tmp \
  --mount=type=tmpfs,dst=/tmp \
  bash <<'RUNEOF'
/* Remove unnecessary files/repositories/etc. */
#include "build_files/cleanup"
/* Remove packages and files not needed for specific version */
#ifdef PLUS
#include "build_files/spamtagger-plus/cleanup"
#else
#include "build_files/spamtagger/cleanup"
#endif /* PLUS */
RUNEOF

/* Copy in cosign.pub key
COPY build_files/cosign.pub /run/build_files/cosign.pub

/* Run Bash recipe to finalize image
RUN bash <<'RUNEOF'
#include "build_files/finalize"
RUNEOF

/* Test BootC image */
RUN ["bootc", "container", "lint", "--fatal-warnings", "--no-truncate"]
RUN ["nbc", "lint", "--local"]

/* LABELS will be added by Justfile */
