# /*
#shellcheck disable=SC2174,SC2114
# */

set ${CI:+-x} -euo pipefail

setterm --foreground green
echo "####################################"
echo "# Preparing filesystem for OSTree..."
echo "####################################"
setterm --foreground default

setterm --foreground blue
echo "# Enabling Non-Free Repository..."
setterm --foreground default

sed -i 's/Components: main/Components: main non-free non-free-firmware/' /etc/apt/sources.list.d/debian.sources

setterm --foreground blue
echo "# Installing dependencies..."
setterm --foreground default

apt-get update
apt install --assume-yes --no-install-recommends --no-install-suggests \
  linux-image-$ARCH \
  $( cat /run/build_files/prepare-filesystem-deps | tr '\n' ' ' )

setterm --foreground blue
echo "# Configuring CoreOS boot recovery..."
setterm --foreground default

COREOS_SULOGIN_GENERATOR_PATH=/usr/lib/systemd/system-generators/coreos-sulogin-force-generator
curl -fSL -o "${COREOS_SULOGIN_GENERATOR_PATH}" https://raw.githubusercontent.com/coreos/fedora-coreos-config/refs/heads/stable/overlay.d/05core/usr/lib/systemd/system-generators/coreos-sulogin-force-generator
echo "------------"
ls /usr/lib/systemd/system-generators
chmod +x "${COREOS_SULOGIN_GENERATOR_PATH}"

setterm --foreground blue
echo "# Configuring BootC..."
setterm --foreground default

sed -i 's|^ExecStart=.*|ExecStart=/usr/bin/bootc update --quiet|' /usr/lib/systemd/system/bootc-fetch-apply-updates.service
sed -i 's|^OnUnitInactiveSec=.*|OnUnitInactiveSec=7d\nPersistent=true|' /usr/lib/systemd/system/bootc-fetch-apply-updates.timer

setterm --foreground blue
echo "# Setting minimum RAM size..."
setterm --foreground default

cat >/usr/lib/systemd/zram-generator.conf <<'EOF'
[zram0]
zram-size = min(ram, 4096)
EOF

setterm --foreground blue
echo "# Configuring OSTree..."
setterm --foreground default

cat >/usr/lib/ostree/prepare-root.conf <<EOF
[composefs]
enabled = signed
[sysroot]
readonly = true
[root]
transient = true
EOF
