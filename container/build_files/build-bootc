# /*
#shellcheck disable=SC2174,SC2114
# */

set ${CI:+-x} -euo pipefail

COMPOSEFS_VERSION=v1.0.8
OSTREE_VERSION=v2025.7
BOOTC_VERSION=v1.10.0

setterm --foreground green
echo "###################"
echo "# Building Bootc..."
echo "###################"
setterm --foreground default

setterm --foreground blue 
echo "# Installing distribution dependencies..."
setterm --foreground default

apt update -y
apt install --assume-yes --no-install-recommends --no-install-suggests $(cat /run/build_files/bootc-deps | tr '\n' ' ')

setterm --foreground blue 
echo "# Installing Rust..."
setterm --foreground default

export CARGO_HOME=/rust
export RUSTUP_HOME=/rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --profile minimal -y
. $CARGO_HOME/env

setterm --foreground blue 
echo "# Building ComposeFS.."
setterm --foreground default

git clone https://github.com/composefs/composefs.git --depth 1 /composefs
cd /composefs
git fetch --tags
git checkout $COMPOSEFS_VERSION
meson -Dprefix=/build/usr build
ninja -C build install
rsync -av /build/usr /
ldconfig

setterm --foreground blue 
echo "# Building OSTree.."
setterm --foreground default

export PKG_CONFIG_PATH=/build/usr/lib/pkgconfig:/usr/share/pkgconfig
git clone https://github.com/ostreedev/ostree.git --depth 1 /ostree
cd /ostree
git fetch --tags
git checkout $OSTREE_VERSION
# /* Copy composefs files to rootfs so that they are found by OSTree */
NOCONFIGURE=1 ./autogen.sh
# /*  First, install to /build for later copying out */
./configure --prefix=/build/usr \
  --enable-experimental-api --enable-embedded-runtime --with-selinux --with-curl --with-ed25519-libsodium \
  --enable-gpgme --with-openssl --with-composefs --with-dracut=yesbutnoconf
make -j$(nproc)
make install
make installdirs
make install-data
make install-exec
for i in $(ls /build); do
  rsync -av /build/$i /
done
ldconfig

setterm --foreground blue 
echo "# Building Bootc..."
setterm --foreground default

export PKG_CONFIG_PATH=/build/usr/lib/pkgconfig:/usr/share/pkgconfig
git clone https://github.com/bootc-dev/bootc.git --depth 1 /bootc
cd /bootc
git fetch --tags
git checkout $BOOTC_VERSION
prefix=/build/usr make
prefix=/build/usr make bin
prefix=/build/usr make install
prefix=/build/usr make install-ostree-hooks
prefix=/build/usr make install-initramfs-dracut
