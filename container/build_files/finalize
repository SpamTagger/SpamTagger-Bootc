# /*
#shellcheck disable=SC2174,SC2114
# */

set ${CI:+-x} -euo pipefail

setterm --foreground green
echo "#####################"
echo "# Finalizing image..."
echo "#####################"
setterm --foreground default

setterm --foreground blue
echo "# Cleaning filesystem for OSTree..."
setterm --foreground default

rm -rf /boot /home /root /usr/local /srv
mkdir -p /boot /sysroot /usr/lib/ostree
mkdir -p /var/roothome
mkdir -p /var/srv
ln -s var/home /home
ln -s var/opt /opt
ln -s var/roothome /root
ln -s sysroot/ostree /ostree

# /* Remove everything except necessary APT files from /var */
mv /var /oldvar
mkdir -p /var/lib /var/cache /var/log/apt
mv /oldvar/lib/apt /var/lib/
mv /oldvar/cache/apt /var/cache/
mv /oldvar/lib/dpkg /var/lib/
rm -rf /oldvar \
  /var/cache/apt/archives \
  /var/lib/apt/lists \
  /var/lib/dpkg/alternatives \
  /var/lib/dpkg/arch-native \
  /var/lib/dpkg/available \
  /var/lib/dpkg/cmethopt \
  /var/lib/dpkg/diversions \
  /var/lib/dpkg/diversions-old \
  /var/lib/dpkg/lock \
  /var/lib/dpkg/lock-frontend \
  /var/lib/dpkg/parts \
  /var/lib/dpkg/status \
  /var/lib/dpkg/status-old \
  /var/lib/dpkg/statoverride-old \
  /var/lib/dpkg/statoverride \
  /var/lib/dpkg/triggers \
  /var/lib/dpkg/updates \
  /var/lib/extended_states \
  /var/lib/mirrors/partial \
  /var/lib/periodic
mkdir /var/lib/apt/lists

setterm --foreground blue
echo "# Adding approved BootC directories..."
setterm --foreground default

echo "$(for dir in opt usrlocal home srv mnt ; do echo "d /var/$dir 0755 root root -" ; done)" | tee -a /usr/lib/tmpfiles.d/bootc-base-dirs.conf
echo "d /var/roothome 0700 root root -" | tee -a /usr/lib/tmpfiles.d/bootc-base-dirs.conf
echo "d /run/media 0755 root root -" | tee -a /usr/lib/tmpfiles.d/bootc-base-dirs.conf

cat >/usr/lib/tmpfiles.d/apt.conf <<EOF
d /var/cache/apt 0755 root root - -
d /var/lib/apt 0755 root root - -
d /var/lib/apt/lists 0755 root root - -
d /var/lib/apt/lists/auxfiles 0755 _apt root - -
d /var/lib/apt/lists/partial 0700 _apt root - -
d /var/lib/apt/mirrors 0755 root root - -
d /var/lib/apt/mirrors/partial 0755 root root - -
d /var/lib/apt/periodic 0755 root root - -
d /var/lib/dpkg 0755 root root - -
d /var/lib/dpkg/alternatives 0755 root root - -
d /var/lib/dpkg/parts 0755 root root - -
d /var/lib/dpkg/triggers 0755 root root - -
d /var/lib/dpkg/updates 0755 root root - -
d /var/lib/mirrors 0755 root root - -
d /var/lib/mirrors/partial 0755 root root - -
d /var/lib/periodic 0755 root root - -
d /var/log/apt - - - -
f /var/lib/apt/extended_states
f /var/lib/apt/lists/lock
EOF

setterm --foreground blue
echo "# Applying custom signing policy..."
setterm --foreground default

rm -rf /usr/etc
cat <<EOF > /etc/containers/policy.json
{
  "default": [
    {
      "type": "reject"
    }
  ],
  "transports": {
    "docker": {
      "ghcr.io/spamtagger": [
        {
          "type": "sigstoreSigned",
          "keyPaths": "/etc/pki/containers/spamtagger.pub",
          "signedIdentity": {
            "type": "matchRepository"
          }
        }
      ],
      "": [
        {
          "type": "insecureAcceptAnything"
        }
      ]
    },
    "docker-daemon": {
      "": [
        {
          "type": "insecureAcceptAnything"
        }
      ]
    }
  }
}
EOF

mkdir -p /etc/containers/registries.d/
cat <<EOF > /etc/containers/registries.d/spamtagger
docker:
  ghcr.io/spamtagger:
    use-sigstore-attachments: true
EOF

mkdir -p /etc/pki/containers/
cp /run/build_files/cosign.pub /etc/pki/containers/spamtagger.pub
