# /*
#shellcheck disable=SC2174,SC2114
# */

set ${CI:+-x} -euo pipefail

setterm --foreground green
echo "####################################"
echo "# Installing packages..."
echo "####################################"
setterm --foreground default

setterm --foreground blue
echo "# Installing dependencies..."
setterm --foreground default

apt-get update
apt install --assume-yes --no-install-recommends --no-install-suggests \
  $(
    cat /run/build_files/variant-packages \
      /run/build_files/version-packages |
      tr '\n' ' '
  )

setterm --foreground blue
echo "# Symlinking /var/opt/..."
setterm --foreground default
mkdir -p /var/opt
rm -rf /opt
ln -sf /var/opt /opt

setterm --foreground blue
echo "# Installing Exim..."
setterm --foreground default
dpkg -i /run/exim-builder/st-exim-*

setterm --foreground blue
echo "# Freeing /usr/local..."
setterm --foreground default
rm -rf /usr/local

setterm --foreground blue
echo "# Configuring CoreOS boot recovery..."
setterm --foreground default
COREOS_SULOGIN_GENERATOR_PATH=/usr/lib/systemd/system-generators/coreos-sulogin-force-generator
curl -fSL -o "${COREOS_SULOGIN_GENERATOR_PATH}" https://raw.githubusercontent.com/coreos/fedora-coreos-config/refs/heads/stable/overlay.d/05core/usr/lib/systemd/system-generators/coreos-sulogin-force-generator
echo "------------"
ls /usr/lib/systemd/system-generators
chmod +x "${COREOS_SULOGIN_GENERATOR_PATH}"

setterm --foreground blue
echo "# Setting minimum RAM size..."
setterm --foreground default
cat >/usr/lib/systemd/zram-generator.conf <<'EOF'
[zram0]
zram-size = min(ram, 4096)
EOF

setterm --foreground blue
echo "# Configuring BootC..."
setterm --foreground default
sed -i 's|^ExecStart=.*|ExecStart=/usr/bin/bootc update --quiet|' /usr/lib/systemd/system/bootc-fetch-apply-updates.service
sed -i 's|^OnUnitInactiveSec=.*|OnUnitInactiveSec=7d\nPersistent=true|' /usr/lib/systemd/system/bootc-fetch-apply-updates.timer
# /*
sed -i 's|#AutomaticUpdatePolicy.*|AutomaticUpdatePolicy=stage|' /etc/rpm-ostreed.conf
sed -i 's|#LockLayering.*|LockLayering=true|' /etc/rpm-ostreed.conf
# */
sed -i 's|^HOME=.*|HOME=/var/home|' "/etc/default/useradd"

setterm --foreground blue
echo "# Setting up systemd-resolved..."
setterm --foreground default
# /*
dnf -y --setopt=install_weak_deps=False install \
  python3-dnf-plugin-versionlock \
  ssh-key-dir \
  systemd-resolved
# */

cat >/usr/lib/systemd/system-preset/91-cayo-resolved.preset <<'EOF'
enable systemd-resolved.service
EOF

cat >/usr/lib/tmpfiles.d/cayo-resolved.conf <<'EOF'
L /etc/resolv.conf - - - - ../run/systemd/resolve/stub-resolv.conf
EOF

systemctl preset systemd-resolved.service

cat >/usr/lib/sysusers.d/ssh.conf <<'EOF'
g _ssh -
EOF

cat >/usr/lib/sysusers.d/ssl-cert.conf <<'EOF'
g ssl-cert -
EOF

setterm --foreground blue
echo "# Installing DCC from OBS..."
setterm --foreground default

cd /tmp/
OBS_PATH="https://download.opensuse.org/repositories/home:/voegelas/Debian_13/$ARCH/"
VERSION=$(curl $OBS_PATH 2>/dev/null | grep -P 'dcc_[0-9]' | grep -v mirrorlist | sed 's/.*href="\.\/\([^"]*\)".*/\1/')
curl -L $OBS_PATH/$VERSION -o $VERSION 2>/dev/null
dpkg -i $VERSION
rm $VERSION

# /* The following Perl libraries were distributed in MailCleaner's 'install/src/perl' directory or
# were included in the list of debian packages but don't appear to be used within the current source
# code. We need to verify which of these dependencies still exist and (eg. via MailScanner) and
# download them via CPAN if we still need them.
#
# AI::Categorizer
# AI::DecisionTree
# Algorithm::NaiveBayes
# Algorithm::SVM
# Archive::Any::Lite
# Archive::Zip
# Archive::Zip::SimpleZip
# BSD::Resource
# Business::ISBN
# Compress::Raw::Zlib
# Compress::Zlib
# config::YAML
# Convert::BinHex
# Convert::TNEF
# Crypt::DES
# Crypt::OpenSSL::AES
# Crypt::OpenSSL::Bignum
# Crypt::OpenSSL::Random
# Crypt::OpenSSL::RSA
# Cwd
# Data::Dump
# Data::Validate::Domain
# Date::Pcalc
# DB_File
# Digest
# Digest::MD5
# Digest::Nilsimsa
# Digest::SHA
# Encode::Detect
# Error
# ExtUtils::CBuilder
# ExtUtils::Constant
# ExtUtils::MakeMaker
# ExtUtils::ParseXS
# File::Spec
# File::Temp
# File::Which
# Filesys::Df
# Getopt::Long
# Geography::Countries
# GeoIP2
# HTML::Parser
# HTML::Tagset
# IMAP::Client
# Inline
# Inline::C
# IO::Socket::IP
# IO::Socket::SSL
# IO::Compress
# IO::Compress::Base
# IO::Compress::Zlib
# IO::String
# IO::stringy
# IO::Socket::INET6
# IO::Socket::SSL
# IP::Country
# Log::Agent
# Log::Log4perl
# Mail::ClamAV
# Mail::DomainKeys
# Mail::SPF::Query
# MLDBM
# MLDBM::Sync
# MIME::Base64
# MIME::Lite
# MIME::tools
# Module::Signature
# NetAddr::IP
# Net::DNS::Resolver::Programmable
# Net::Ident
# Net::IMAP::Simple
# Net::IMAP::Simple::SSL
# NetSNMP::default_store
# Net_SSLeay.pm
# NTLM
# OLE::Storage_Lite
# OO.pm.patch
# Parse::RecDescent
# Pod::Escapes
# Pod::Parser
# Pod::Simple
# Pod::Readme
# podlators
# PathTools
# re2c
# Scalar::List::Utils
# Socket
# Socket6
# Statistics::Contingency
# Storable
# String::Approx
# Sys::SigAction
# Sys::Hostname::Long
# Tie::Cache
# Time::HiRes
# Time::Progress
# TimeDate
# Test::Simple
# Test::Harness
# URI::imap
# URI::Find::Rule
# version
# XML::Parser
# */

# /* Possibly replaced by perl-Razor-Agent, but would likely need an updated module.
# razor
# */

# /*
# Build our own Perl. The one in the repositories has over 100MB of dependencies.
#
# TODO: Use App::StaticPerl to build a minimal Perl and bundle in all dependencies
#
# */

cd /tmp
git clone --depth=1 https://github.com/Perl/perl5
cd perl5
git fetch --tags
PERLVERSION=$(apt-cache show perl | grep Version: | sed -r 's/Version: (5\.[0-9][24680].[0-9]*).*/\1/')
git checkout v$PERLVERSION
./configure.gnu
make
make test
make install
cd ..
rm -rf perl5

# /*
# Try getting all PHP dependencies through composer
# php-bcmath 
# php-common 
# php-dba 
# php-gd 
# php-gmp 
# php-intl 
# php-mbstring 
# php-pecl-memcache 
# php-mysqlnd 
# php-pear 
# php-snmp 
# php-soap 
# php-xml 
# php-pecl-zip
#
# Missing php modules
# php-imap
# php-mcrypt
# php-xmlrpc (provided by Zend)
# */

# /*
# Install missing Perl dependencies from CPAN
# GreylistD doesn't have an official package. Investigate built-in greylisting configuration provided by exim-greaylist:
# https://github.com/Exim/exim/wiki/SimpleGreylisting
# Otherwise, greylistd is just a python program, so we can fetch from GitHub and write a simple installer.
# git clone https://github.com/SpamTagger/greylistd
# */

# /*
# missing Apache modules
# libapache2-mpm-itk (or something like (mod_mpm-itx) doesn't exist. Other MPM modules probably exist, but I don't think we actually need to run multilple vhosts, so this is not needed.
# */

# /*
# Dependencies for custom Exim package. Test what features are missing from CentOS package before compiling our own.
# libssl3 (now openssl-devel?) 
# libpcre3
# */

# /* Pending acceptance for EPEL 10 https://bodhi.fedoraproject.org/updates/?packages=pwgen
# Maybe just generate our own random password (used in install/installer.pl).
#
# pwgen
# */

# /* Missing, perhaps resolved my net-snmp
# snmp-mibs-downloader
# */
cpanm Mail::IMAPClient
cpanm Mail::POP3Client
cpanm RRDTool::OO
cpanm IPC::Shareable
cpanm IO::Interactive

# /*
# 
# Missing Debian 13 packages:
# 
# Provide our own:
# 
# libspf2
# exim
# exim-greylist
# 
# Manually restore with script:
# 
# clamav-unofficial-sigs
# */

# /*
# TODO: Remove packages which are not useful in mail filtering context
# TODO: `wget` is mostly redundant to `curl`, but the latter is required by the system.
# `wget is used in the application code but could be removed in favour of `curl` in bash and `LWP` in Perl
# */
