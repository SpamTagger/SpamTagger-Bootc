# /*
#shellcheck disable=SC2174,SC2114
# */

set ${CI:+-x} -euo pipefail

setterm --foreground green
echo "################"
echo "# Cleaning up..."
echo "################"
setterm --foreground default

setterm --foreground blue
echo "# Freeing /usr/local..."
setterm --foreground default

rm -rf /usr/local

setterm --foreground blue
echo "# Generating kernel ..."
setterm --foreground default

export DRACUT_NO_XATTR=1
export KERNEL_VERSION="$(basename "$(find /usr/lib/modules -maxdepth 1 -type d | grep -v -E "*.img" | tail -n 1)")"
dracut --debug --force --no-hostonly --reproducible --zstd --verbose --kver "$KERNEL_VERSION" "/usr/lib/modules/$KERNEL_VERSION/initramfs.img"
mv /boot/vmlinuz-${KERNEL_VERSION}* "/usr/lib/modules/$KERNEL_VERSION/vmlinuz"

setterm --foreground blue
echo "# Remove unneeded packages..."
setterm --foreground default

REMOVE=$(cat /run/build_files/variant-cleanup /run/build_files/version-cleanup | tr '\n' ' ')
if [[ ! "$REMOVE" == "" ]]; then
  apt-get purge -y $REMOVE
fi
apt-get autoremove -y --purge
apt-get clean
rm -rf /var/cache/apt
rm -rf /var/lib/apt/list*
