# /*
#shellcheck disable=SC2174,SC2114
# */

set ${CI:+-x} -euo pipefail

setterm --foreground green
echo "##################################"
echo "# SpamTagger Configuration..."
echo "##################################"
setterm --foreground default

setterm --foreground blue
echo "# Setting up SpamTagger users..."
setterm --foreground default

cat >/usr/lib/sysusers.d/mysql.conf <<'EOF'
u mysql -
EOF

cat >/usr/lib/sysusers.d/ssl-cert.conf <<'EOF'
g ssl-cert -
EOF

setterm --foreground blue
echo "# Cloning SpamTagger and Zend..."
setterm --foreground default
git clone --recurse-submodules --depth=1 https://github.com/SpamTagger/SpamTagger /usr/spamtagger

setterm --foreground blue
echo "# Cleaning up repo files..."
setterm --foreground default

rm -rf /usr/spamtagger/.git*
mv /usr/spamtagger/www/vendor/Zend /usr/spamtagger/www/vendor/Zend.git
mv /usr/spamtagger/www/vendor/Zend.git/library/Zend /usr/spamtagger/www/vendor/Zend
rm -rf /usr/spamtagger/www/vendor/Zend.git

setterm --foreground blue
echo "# Configuring BootC..."
setterm --foreground default

mkdir -p /usr/share/bootc
echo "SpamTagger Appliance" > /usr/share/bootc/description

setterm --foreground blue
echo "# Updating os-release..."
setterm --foreground default
sed -i 's|^BUG_REPORT_URL=.*|BUG_REPORT_URL="https://github.com/SpamTagger/SpamTagger/issues"|' /usr/lib/os-release
echo 'VARIANT="SpamTagger"' >>/usr/lib/os-release

setterm --foreground blue
echo "# Updating /etc/issue..."
setterm --foreground default

setterm --foreground blue
echo "# Updating /etc/motd..."
setterm --foreground default

echo "Welcome to SpamTagger!" >> /etc/motd

setterm --foreground blue
echo "# Setting default password (STPassw0rd)..."
setterm --foreground default

sed -i 's/root:[^:]*:/root:$y$j9T$kfLbiAeBa5PuQAZtTqBph1$ufRc85kbALH5Eg.IhtZcoyoDZ92SZfJmdX9p22Qg1D5:/' /etc/shadow

setterm --foreground blue
echo "# Creating empty configuration file..."
setterm --foreground default

touch /etc/spamtagger.conf

setterm --foreground blue
echo "# Applying Anaconda installer configuration..."
setterm --foreground default

if [ ! -d /etc/anaconda/conf.d ]; then
  mkdir -p /etc/anaconda/conf.d
fi
cp /usr/spamtagger/install/anaconda/conf.d/spamtagger.conf /etc/anaconda/conf.d/
# /*
#if [ ! -d /etc/anaconda/post-scripts ]; then
#mkdir -p /etc/anaconda/post-scripts
#fi
#cp /usr/spamtagger/install/anaconda/post-scripts/spamtagger.ks /etc/anaconda/conf.d/
# */
if [ ! -d /etc/anaconda/profile.d ]; then
  mkdir -p /etc/anaconda/profile.d
fi
cp /usr/spamtagger/install/anaconda/profile.d/spamtagger.conf /etc/anaconda/profile.d/
